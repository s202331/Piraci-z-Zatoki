---
title: "Analiza Sklepu Rowerowego"
author: "Jagoda Chęcińska, Piotr Łukowski, Tomasz Kotliński"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

# Piraci-z-Zatoki: Analiza Sklepu Rowerowego

## Wstęp

Klienci sklepu rowerowego wzięli udział w ankiecie, w której dostarczyli
szczegółowe informacje na swój temat, takie jak: status cywilny, płeć,
poziom dochodów, liczba dzieci, poziom wykształcenia, wykonywany zawód,
status posiadania domu, liczba samochodów, odległość do miejsca pracy,
region zamieszkania oraz wiek.

Celem analizy jest określenie, które z tych czynników mają największy
wpływ na decyzję o zakupie roweru.

------------------------------------------------------------------------

## Data Wrangling

W pierwszym etapie projektu przeprowadzono instalajcę oraz załadowanie
pakietów niezbędnych do analizy danych.

```{r}
install.packages(c("readr", "naniar", "dplyr","summarytools", "tidyr","car","psych", 
                   "ggplot2", "mice", "rpart","ggcorrplot","rpart.plot", "gridExtra", 
                   "factoextra", "plyr"))
library(readr)
library(naniar)
library(plyr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(mice)
library(rpart)
library(ggcorrplot)
library(rpart.plot)
library(factoextra)
library(gridExtra)
library(car)
library(psych)
library(summarytools)
library(readr)
read.csv("sklep_rowerowy.csv")
sklep_rowerowy <- read.csv("sklep_rowerowy.csv")
```

# Podstawowa analiza braków

## Identyfikacja braków w danych

W celu oceny kompletności zbioru danych „sklep_rowerowy” przeprowadzono
analizę brakujących wartości. Wyniki wskazują, że w zestawie danych
znajduje się 31 brakujących wartości. W zbiorze brakuje 0,4% wartości,
głównie w kolumnach: - Gender - Cars - Children - Age - Marital Status

```{r}
n_miss(sklep_rowerowy) 
vis_miss(sklep_rowerowy) 
miss_var_summary(sklep_rowerowy) 
```

## Wizualizacja braków danych

```{r}
braki_procent <- sklep_rowerowy %>%
  summarise(across(everything(), ~ mean(is.na(.)) * 100)) %>%  
  pivot_longer(everything(), names_to = "Kolumna", values_to = "Procent")  # Przekształcenie do długiego formatu

ggplot(braki_procent, aes(x = reorder(Kolumna, -Procent), y = Procent)) +  
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() +
  labs(title = "Procent brakujących danych w kolumnach",
       x = "Kolumna", y = "% braków") +
  theme_minimal()
```

# Przypisywanie zmiennych typu factor

W celu poprawności analiz dokonano konwersji wybranych kolumn na zmienne
kategoryczne (factor), obejmujących m.in. stan cywilny, płeć,
wykształcenie, zawód, status własności nieruchomości, dystans do pracy,
region oraz decyzję o zakupie roweru. Przekształcenie to umożliwia
poprawne traktowanie danych przez R jako nominalne lub porządkowe, co
jest istotne dla analiz statystycznych, modeli predykcyjnych oraz
wizualizacji.

```{r}

sklep_rowerowy <- sklep_rowerowy %>%
  mutate(
    `Marital.Status` = na_if(`Marital.Status`, ""),
    Gender = na_if(Gender, ""),
    `Home.Owner` = na_if(`Home.Owner`, ""),
    `Marital.Status` = factor(`Marital.Status`),
    Gender = factor(Gender),
    Education = factor(Education),
    Occupation = factor(Occupation),
    `Home.Owner` = factor(`Home.Owner`),
    `Commute.Distance` = factor(`Commute.Distance`),
    Region = factor(Region),
    `Purchased.Bike` = factor(`Purchased.Bike`)
  )
```

# Imputacja Danych

W celu uzupełnienia brakujących wartości w zbiorze "sklep_rowerowy"
zastosowano średnią adaptacyjną do zmiennych liczbowych oraz metodę
Predictive Mean Matching (pmm) dla zmiennych kategorycznych. Imputacja
pozwoliła na eliminację braków danych, co zwiększa kompletność i
wiarygodność zbioru, umożliwiając dokładniejsze analizy. Dzięki tym
metodom zachowano strukturę danych, minimalizując wpływ braków na wyniki
statystyczne i modele predykcyjne. Wizualizacja potwierdza, że po
imputacji wszystkie kolumny są w pełni uzupełnione (0% braków).

```{r}
sklep_rowerowy <- sklep_rowerowy %>%
mutate(across(where(is.numeric), ~ ifelse(is.na(.), mean(., na.rm = TRUE, trim = 0.1), .)))

imputed_data <- mice(sklep_rowerowy, m = 5, method = 'pmm', seed = 123)
sklep_rowerowy <- complete(imputed_data)

sklep_rowerowy

n_miss(sklep_rowerowy)

vis_miss(sklep_rowerowy) + labs(title = "Braki danych po imputacji")
```

## Wizualizacje

1.  Rozkład zmiennych liczbowych i kategorycznych Przeanalizowano
    rozkład zmiennych liczbowych oraz kategorycznych w zbiorze
    "sklep_rowerowy". Histogramy przedstawiają rozkład wartości w
    zmiennych takich jak wiek (Age), liczba samochodów (Cars), liczba
    dzieci (Children), dochód (Income), ukazując różnorodność danych i
    potencjalne odstępstwa. Wykresy kategorii pokazują liczbę obserwacji
    dla zmiennych takich jak płeć, wykształcenie, region oraz status
    zakupu roweru.

2.  Czynniki wpływające na zakup roweru Dane wskazują na zróżnicowanie
    decyzji zakupowych w zależności od regionu, gdzie w Ameryce
    Północnej zakupów jest najwięcej, a w regionie Pacyfiku najmniej.
    Istotnym czynnikiem jest także dystans do pracy, gdzie osoby
    mieszkające bliżej (0-1 mil) częściej decydują się na zakup roweru.

3.  Dochód klientów a zakup roweru Analiza dochodów pokazuje, że
    większość klientów ma dochody w przedziale 25 000 - 75 000, przy
    czym nie ma wyraźnej różnicy w zakupach rowerów w zależności od
    dochodu. Wykres pudełkowy dochodów w regionach wskazuje, że
    najwyższe zarobki występują w regionie Pacyfiku, a najniższe w
    Europie.

4.  Korelacje między zmiennymi Macierz korelacji wykazuje, że najwyższa
    zależność występuje między liczbą dzieci a dochodem (0,53) oraz
    liczbą samochodów a dochodem (0,43). Sugeruje to, że dochód jest
    kluczowym czynnikiem wpływającym na styl życia klientów

```{r}
sklep_rowerowy %>%
select(where(is.numeric)) %>%
pivot_longer(everything()) %>%
ggplot(aes(x = value)) +
geom_histogram(bins = 30, fill = "skyblue", color = "black") +
facet_wrap(~ name, scales = "free") +
labs(title = "Rozkład zmiennych liczbowych", x = "Wartość", y = "Częstość") +
theme_minimal()   

sklep_rowerowy %>%
select(where(is.factor)) %>%
pivot_longer(everything()) %>%
ggplot(aes(x = value)) +
geom_bar(fill = "steelblue") +
facet_wrap(~ name, scales = "free") +
labs(title = "Rozkład zmiennych kategorycznych", x = "Kategorie", y = "Liczba obserwacji") +
theme_minimal()  

  ggplot(sklep_rowerowy, aes(x = Region, fill = Purchased.Bike)) +
    geom_bar(position = "dodge") +
    labs(title = "Zakup rowerów względem regionu",
         x = "Region",
         y = "Liczba zakupów",
         fill = "Zakup roweru (No = 0, Yes = 1)") +
    theme_minimal()
  
ggplot(sklep_rowerowy, aes(x = Commute.Distance, fill = Purchased.Bike)) +
  geom_bar(position = "dodge") +
  labs(title = "Zakup rowerów względem przejechanych kilometrów",
       x = "Dystans dojazdu do pracy",
       y = "Liczba zakupów",
       fill = "Zakup roweru (No = 0, Yes = 1)") +
  theme_minimal()

ggplot(sklep_rowerowy, aes(x = Income, fill = Purchased.Bike)) +
  geom_histogram(position = "dodge", bins = 30, alpha = 0.7) +
  labs(title = "Dochód klientów względem zakupu roweru",
       x = "Dochód",
       y = "Liczba klientów",
       fill = "Zakup roweru (No = 0, Yes = 1)") +
  theme_minimal()

ggplot(sklep_rowerowy, aes(x = Region, y = Income, fill = Region)) +
  geom_boxplot() +
  labs(title = "Dochód klientów w różnych regionach",
       x = "Region",
       y = "Dochód") +
  theme_minimal()

cor_matrix <- cor(sklep_rowerowy %>% select(where(is.numeric)), use = "complete.obs")
ggcorrplot(cor_matrix, hc.order = TRUE, type = "lower", lab = TRUE)
```

## Model drzewa decyzyjnego

1.  Budowa modelu W celu przewidywania zakupu roweru zbudowano model
    drzewa decyzyjnego, wykorzystując dane treningowe stanowiące 70%
    zbioru, a pozostałe 30% jako zbiór testowy. Model został wytrenowany
    na podstawie zmiennych niezależnych, a następnie zwizualizowany, co
    umożliwia interpretację kluczowych czynników wpływających na zakup
    roweru.

2.  Wyniki predykcji Macierz pomyłek pokazuje, że model poprawnie
    sklasyfikował 98 przypadków braku zakupu oraz 77 przypadków zakupu,
    jednak 71 osób, które nie kupiły roweru, zostało błędnie
    zaklasyfikowanych jako kupujący, a 54 osoby, które dokonały zakupu,
    zostały zaklasyfikowane jako niekupujący.

3.  Dokładność modelu Uzyskana dokładność modelu wynosi 58,33%, co
    sugeruje umiarkowaną skuteczność klasyfikacji. Wynik ten może
    wskazywać na potrzebę optymalizacji modelu, np. poprzez pruning
    drzewa, zastosowanie innych metod klasyfikacyjnych lub inżynierię
    cech w celu zwiększenia jego predykcyjnej wartości.

```{r}
set.seed(123)
train_index <- sample(seq_len(nrow(sklep_rowerowy)), size = 0.7 * nrow(sklep_rowerowy))
train_data <- sklep_rowerowy[train_index, ]
test_data <- sklep_rowerowy[-train_index, ]

tree_model <- rpart(`Purchased.Bike` ~ ., data = train_data, method = "class")
tree_model


rpart.plot(tree_model, type = 4, extra = 104, fallen.leaves = TRUE, 
           box.palette = "RdBu", shadow.col = "gray", nn = TRUE )
          

### W tej sekcji wykorzystujemy model drzewa decyzyjnego do przewidywania wyników na zbiorze testowym oraz oceniamy jego skuteczność

### Przewidywanie wyników
## Model jest stosowany do przewidywania wartości zmiennej `Purchased.Bike` na podstawie danych testowych.
tree_predictions <- predict(tree_model, test_data, type = "class")

### Ocena jakości modelu
## Aby określić skuteczność modelu, tworzymy macierz pomyłek, która pozwala ocenić liczbę poprawnie i błędnie sklasyfikowanych przypadków.
conf_matrix <- table(Predicted = tree_predictions, Actual = test_data$`Purchased.Bike`)
conf_matrix

### Obliczanie dokładności modelu
## Dokładność modelu obliczamy jako stosunek poprawnych przewidywań do całkowitej liczby obserwacji w zbiorze testowym.
accuracy <- mean(tree_predictions == test_data$`Purchased.Bike`)
cat("Dokładność modelu drzewa decyzyjnego:", round(accuracy * 100, 2), "%\n")
```

# Segmentacja klientów (Klasteryzacja K-średnich) dla osób które kupiły rower ze względu na dane numeryczne

Przeprowadzono segmentację klientów, którzy kupili rower, wykorzystując
metodę K-średnich na podstawie numerycznych cech. Dane zostały
standaryzowane, a optymalną liczbę klastrów określono metodą WSS (Elbow
Method). Klasteryzacja podzieliła klientów na trzy grupy, co
wizualizacja przedstawia jako odrębne segmenty. Analiza ta pozwala
lepiej zrozumieć różnice między kupującymi oraz identyfikować ich
charakterystyczne cechy, co może być użyteczne w strategiach
marketingowych i sprzedażowych.

```{r}

bike_buyers <- sklep_rowerowy %>% filter(Purchased.Bike == "Yes")

cluster_data <- bike_buyers %>% select(where(is.numeric))
cluster_data_scaled <- scale(cluster_data)

fviz_nbclust(cluster_data_scaled, kmeans, method = "wss")

set.seed(123)
kmeans_model <- kmeans(cluster_data_scaled, centers = 3, nstart = 25)

fviz_cluster(kmeans_model, data = cluster_data_scaled, geom = "point") +
  labs(title = "Segmentacja klientów - Klasteryzacja K-średnich (Kupujący rowery)")
```

# Test Shapiro-Wilka dla dochodu a zakupu roweru

Pomaga określić, czy stosować testy parametryczne czy nieparametryczne.

```{r}
by(sklep_rowerowy$Income, sklep_rowerowy$`Purchased.Bike`, shapiro.test)
```

# Test Kruskala-Wallisa dla zakupu roweru a dochodu

```{r}
kruskal_test_income_purchasedbike <- kruskal.test(Income ~ `Purchased.Bike`, data = sklep_rowerowy)
print(kruskal_test_income_purchasedbike)
```

# Powiązanie testów z analizą klientów

```{r}
# - Test Shapiro-Wilka: Wyniki testu wykazały, że dochód nie ma rozkładu normalnego zarówno w grupie kupujących, jak i niekupujących roweru (p < 0,05). Wskazuje to, że w dalszej analizie należy stosować testy nieparametryczne (np. Kruskala-Wallisa) zamiast testów parametrycznych (np. ANOVA).
# - Test Kruskala-Wallisa: Wynik testu (p = 0.1274) wskazuje, że dochód nie różni się istotnie między osobami, które kupiły rower, a tymi, które go nie kupiły. Oznacza to, że dochód nie jest kluczowym czynnikiem decyzyjnym przy zakupie roweru – inne aspekty, takie jak region zamieszkania, dystans do pracy czy styl życia, mogą mieć większe znaczenie.
# Dochod nieistotny dupa może region 
```

# Test Kruskala- Wallisa dla zakupu roweru a regionu

```{r}
kruskal_test_Region_purchasedbike <- kruskal.test(Region ~ `Purchased.Bike`, data = sklep_rowerowy)
print(kruskal_test_Region_purchasedbike)
```

# Test Kruskala - Wallisa dla zakupu roweru a dystans do pracy

```{r}
kruskal_test_Commute_Distance_purchasedbike <- kruskal.test(`Commute.Distance` ~ `Purchased.Bike`, data = sklep_rowerowy)
print(kruskal_test_Commute_Distance_purchasedbike)
```

# Analiza wyniku testu Kruskala-Wallisa dla dystansu do pracy a zakupu roweru

```{r}
# Przeprowadzony test Kruskala-Wallisa wykazał istotne statystycznie różnice w dystansie do pracy między osobami, które kupiły rower, a tymi, które go nie kupiły (p = 0.0067). Oznacza to, że dystans do pracy jest kluczowym czynnikiem wpływającym na decyzję zakupową, co potwierdzają wcześniejsze wizualizacje. Wynik sugeruje, że osoby pokonujące określone odległości częściej decydują się na zakup roweru, dlatego warto skupić się na segmentacji klientów według dystansu i dostosowaniu strategii marketingowych do tej grupy.
```

# Statystyki opisowe dla zmiennych liczbowych

W analizowanym zbiorze danych kluczowe zmienne liczbowe obejmują m.in.
dochód klientów (Income) oraz dystans dojazdu do pracy. Obliczamy
podstawowe statystyki, takie jak: - Średnia arytmetyczna (mean) –
określa przeciętną wartość danej cechy, - Mediana (median) – wartość
środkowa, mniej podatna na wartości odstające, - Odchylenie standardowe
(sd) – określa zmienność w ramach danej zmiennej

```{r}

sklep_rowerowy %>% summarise(across(where(is.numeric), list(
  mean = ~mean(.x, na.rm = TRUE),
  median = ~median(.x, na.rm = TRUE),
  sd = ~sd(.x, na.rm = TRUE)
)))
```

# Statystyki opisowe dla zmiennych kategorycznych

Analizujemy również zmienne kategoryczne, takie jak region zamieszkania
(Region), poziom wykształcenia (Education) czy czy klient kupił rower
(Purchased.Bike). Dla tych zmiennych tworzymy tabelę liczebności, aby
zidentyfikować dominujące grupy klientów.

```{r}
sklep_rowerowy %>% summarise(across(where(is.factor), ~list(table(.))))
```

# Podsumowanie statystyk opisowych

1.  Kluczowe statystyki opisowe: Dochód (Income): Średnia wynosi 56
    252,1 z dużym rozrzutem (od 10 000 do 170 000). Wiek (Age): Średnia
    wynosi 44,2, a mediana 43 lata, z minimalnym wiekiem 25 lat i
    maksymalnym 89 lat. Liczba dzieci (Children): Średnia 1.9, przy
    wartości od 0 do 5. Liczba samochodów (Cars): Średnia 1.5, większość
    osób posiada od 0 do 2 pojazdów.
2.  Struktura demograficzna i społeczna: Płeć (Gender): Kobiety i
    mężczyźni są prawie równomiernie podzieleni (49,4% vs. 50,6%). Stan
    cywilny (Marital Status): 53,8% osób jest w związku małżeńskim, a
    46,2% to osoby samotne. Wykształcenie (Education): Najwięcej osób ma
    stopień licencjata (30,6%), a najmniej niepełne wykształcenie
    średnie (7,6%). Status własności nieruchomości (Home Owner): 68,4%
    klientów posiada własne mieszkanie lub dom.
3.  Charakterystyka transportu: Dystans do pracy (Commute Distance):
    Najwięcej osób dojeżdża 0-1 mili (36,6%), podczas gdy najrzadziej
    spotykany dystans to 10+ mil (11,1%). Region zamieszkania (Region):
    30% klientów pochodzi z Europy, 50,8% z Ameryki Północnej, a 19,2% z
    regionu Pacyfiku.
4.  Decyzja o zakupie roweru: 51,9% klientów nie kupiło roweru, a 48,1%
    zdecydowało się na zakup. Wnioski: Z analizy wynika, że dochody są
    zróżnicowane, a większość klientów mieszka blisko miejsca pracy.
    Własność nieruchomości i liczba samochodów mogą wpływać na decyzję o
    zakupie roweru, natomiast region zamieszkania wydaje się mniej
    istotny.

```{r, results='asis'}
library(summarytools)
dfSummary(sklep_rowerowy) %>% print(method = "render", style = "grid")
```

# Wizualizacja testów

```{r}

ggplot(sklep_rowerowy, aes(x = Purchased.Bike, fill = Region)) +
  geom_bar(position = "dodge") +
  labs(title = "Zakup roweru a region", x = "Zakup roweru", y = "Liczba kupionych rowerów") +
  theme_minimal() +
  scale_x_discrete(labels = c("Nie kupiono", "Kupiono"))

ggbetweenstats( data = sklep_rowerowy, x = Purchased.Bike,
y = Income,
type = "nonparametric",
title = "Dochód a = zakup roweru", xlab = "Zakup roweru", ylab = "Dochód", )

group_by(Purchased.Bike) %>%
  summarise(Commute.Distance = mean(Commute.Distance, na.rm = TRUE))

```

Podsumowanie

Z przeprowadzonej analizy wynika iż głównymi powodami zakupu rowerów jest (Commute.Distance) trasa do pokonania do pracy, oraz wiek i region.

Z przeprowadzonych testów Kruskala-Wallisa znaleziono zależność miedzy trasą do pokonania a zakupem roweru, wykazały istotnie statystyczne różnice w dystansie do pracy miedzy osobami ktore kupiły rower a osobami które go nie kupiły.
Oznacza to że dystans do pracy jest kluczowym czynnikiem wpływającym na zakup roweru.
Im mniejsza odległość do pracy tym chętniej kupujemy rower.

W ramach analizy statystycznej przeprowadzono również segmentację klientów na podstawie profilu klientów, co pozwoliło zidentyfikować różne grupy konsumentów.

Podsumowując, wyniki analizy wskazują na dużą koncentrację klientów w określonych grupach wiekowych oraz o dużej zależności miedzy odległością do pracy a zakupem roweru. Przeprowadzone analizy pozwalają na lepsze zrozumienie potrzeb klientów, co może przyczynić się do poprawy efektywności działań marketingowych i sprzedażowych sklepu rowerowego.